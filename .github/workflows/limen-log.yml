name: LIMEN Log
on:
  issues:
    types: [opened]

jobs:
  log:
    if: startsWith(github.event.issue.title, 'LIMEN:')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Parse and commit
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          python3 -c "
import json, os, datetime

title = os.environ.get('ISSUE_TITLE', '').replace('LIMEN: ', '', 1)
body = os.environ.get('ISSUE_BODY', '')

entry = {
    'timestamp': datetime.datetime.now(datetime.UTC).isoformat() + 'Z',
    'summary': title,
    'projects': [], 'decisions': [], 'pending': [],
    'mistakes': [], 'insights': []
}

for line in body.split('\n'):
    line = line.strip()
    for field in ['projects', 'decisions', 'pending', 'mistakes', 'insights']:
        if line.lower().startswith(field + ':'):
            entry[field] = [x.strip() for x in line.split(':', 1)[1].split(',') if x.strip()]

with open('state/limen.json') as f:
    state = json.load(f)

state['log'].append(entry)
state['log'] = state['log'][-200:]
state['meta']['total_conversations'] = len(state['log'])
state['meta']['last_saved'] = entry['timestamp']

# Add any new pending items
for p in entry.get('pending', []):
    if p not in state['pending']:
        state['pending'].append(p)

with open('state/limen.json', 'w') as f:
    json.dump(state, f, indent=2)

print(f'Logged: {title}')
"
      - name: Commit
        run: |
          git config user.name "LIMEN"
          git config user.email "limen@users.noreply.github.com"
          git add state/limen.json
          git commit -m "log: ${{ github.event.issue.title }}"
          git push
      - name: Close issue
        run: gh issue close ${{ github.event.issue.number }} --comment "Logged."
        env:
          GH_TOKEN: ${{ github.token }}
